#!/bin/bash

# Função para exibir mensagem de uso
usage() {
    echo "Uso: $0 NUMERO [-p]"
    echo "    NUMERO: número de aliases"
    echo "    -p: opcional, enviar requisição via proxy (http://127.0.0.1:8080)"
    exit 1
}

# Verifica se o número de argumentos é válido
if [ "$#" -lt 1 ] || [ "$#" -gt 2 ]; then
    usage
fi

# Parse dos argumentos
num_aliases=$1
send_via_proxy=false

# Verifica se a opção de proxy foi fornecida
if [ "$#" -eq 2 ] && [ "$2" == "-p" ]; then
    send_via_proxy=true
elif [ "$#" -eq 2 ]; then
    usage
fi

# Gera a consulta com o número de aliases fornecido
query=$(./programa.sh "$num_aliases")

# Configuração do proxy
proxy_option=""
if [ "$send_via_proxy" = true ]; then
    proxy_option="-x http://127.0.0.1:8080"
fi

# Envia a consulta para o servidor usando curl
curl --path-as-is -i -s -k -X POST \
    -H "Host: www.demarches-simplifiees.fr" \
    -H "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:125.0) Gecko/20100101 Firefox/125.0" \
    -H "Accept: application/json, multipart/mixed" \
    -H "Accept-Language: en-US,pt-BR;q=0.8,pt;q=0.5,en;q=0.3" \
    -H "Accept-Encoding: gzip, deflate, br" \
    -H "Referer: https://www.demarches-simplifiees.fr/graphql" \
    -H "Content-Type: application/json" \
    -H "X-Csrf-Token: Lo7PA103O-bksGwasqzxBf_QHboj3Vqzc0PS2_aEGohRQ9uxUvlQ-NaIQjtyJz5dz0sgDz7A9gn3F6-QWrOpXA" \
    -H "Content-Length: ${#query}" \
    -H "Origin: https://www.demarches-simplifiees.fr" \
    -H "Sec-Fetch-Dest: empty" \
    -H "Sec-Fetch-Mode: cors" \
    -H "Sec-Fetch-Site: same-origin" \
    -H "Te: trailers" \
    -b "_csrf_token=eyJfcmFpbHMiOnsibWVzc2FnZSI6IklsUjZWbmQ1U214a1kwWllkSE5oV2t0aGVHMWlVMVpFYUVsTmJIWmthRmxFZFRsTFMyZExNMk5KVDBFaSIsImV4cCI6IjIwMjUtMDQtMjVUMTU6MTU6NTEuNTk2WiIsInB1ciI6ImNvb2tpZS5fY3NyZl90b2tlbiJ9fQ%3D%3D--d740fd6c5d9997a35fba89ccd3a7658f2c7be420; _DS_session=EIaqiEOXk9C0ZKbb7PrtHXVOnb%2FZdck%2FkPsuhSQBvxt02Axmzk%2F9BFwrVwweOF7BkL2Qa3CduKsH7387lftKnWsgBs%2B4WCIY%2BUnq1GTsaRXyCaWWAZ0V5bL7oJgWrYmySJ8ZP6xmaSrE%2BvrU8VDEsgATVrkjnBor%2F184QGrscfF1%2F%2BKnkR%2F9V8ZHYRsWXJOwF3CCILshdsv5Qp5Cf9u1bCTHxzSfHlTjafTv7qsfVAqRi9ieXcQPZKGRjyLCGcyYX%2BcmybCkyDepPckOVzfItfBabw%3D%3D--%2FuIPly6Z%2BNA8%2BetX--qI1LUeNY9EQCNgpVP0UkOg%3D%3D; _pk_id.73.dc9f=5d578b0a60aba18a.1714058077.; _pk_ses.73.dc9f=1" \
    --data-raw "$query" \
    $proxy_option \
    https://www.demarches-simplifiees.fr/api/v2/graphql

